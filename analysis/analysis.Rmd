---
title: "R Notebook"
output:
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)

library(tidyverse)
library(pbapply)
library(ggplot2)
library(janitor)
library(stringr)
library(anytime)

# this is where the result of the parallel is stored
RUN_DIR=file.path("..", "runs/packages")

COLS = tribble(
  ~column, ~description,
  "n_projects", "number of projects",
  "n_traces", "number of all traces (i.e. the some of the following)",
  "n_complete", "number of traces from which we can generate tests",
  "n_entry", "number of function entry traces",
  "n_error", "number of functions that returned exception (only available in `trycatch` decorator)",
  "n_failures", "number of trace failures (exception during args/retv recording)"
)

is_package_ready <- function(path) {
  file.exists(file.path(path, "run-package", "output", "none", "all", "genthat-traces.csv")) &&
    file.exists(file.path(path, "trace", "output", "onexit--set", "all", "genthat-traces.csv")) &&
    file.exists(file.path(path, "generate", "output", "genthat-generate.csv")) &&
    file.exists(file.path(path, "run", "output", "genthat-run-tests.csv"))
}

format_difftime <- function(x, ...) {
  x <- as.integer(x)
  sprintf(
    "%02d:%02d:%02d", 
    x %% (24*60*60) %/% (60*60),
    x %% (60*60) %/% 60,
    x %% 60 %/% 1
  )
}

format_size <- function(x) {
  if (is.na(x)) return(NA)
  
  units <- c("B", "kB", "MB", "GB", "TB", "PB")
  
  fmt <- function(x, i=1) {
    xx <- x / 1024
    if (abs(xx) > 1 && i < length(units)) {
      fmt(xx, i+1)
    } else {
      sprintf("%.2f %s", x, units[i])
    }
  }
  
  sapply(x, fmt, USE.NAMES=FALSE)
}
```

# Running the experiment

```{r}
packages_paths <- list.dirs(RUN_DIR, recursive=FALSE) %>% keep(is_package_ready)
packages <- basename(packages_paths)
result <- data_frame(package=packages, path=packages_paths)
```

## List of participating packages

```{r}
DT::datatable(result)
```


# Execution logs

In this section we look at the output form GNU parallel.

```{r}
read_parallel_log <- function(package, fname) {
  read_tsv(
    fname, 
    col_types=cols_only(
      Seq="i",
      Starttime="d",
      JobRuntime="d",
      Exitval="i",
      Signal="i",
      Command="c"
    )
  ) %>%
  transmute(
    package=package,
    started=anytime(Starttime),
    ended=anytime(Starttime+JobRuntime),
    duration=ended-started,
    status=Exitval,
    signal=Signal,
    command=Command
  )
}

load_file_from_packages <- function(filepath, fun) {
  result %>%
    transmute(package, fname=file.path(path, filepath)) %>% 
    pmap_dfr(fun)
}

read_parallel_logs <- function(task_name) {
  load_file_from_packages(file.path(task_name, "parallel.log"), read_parallel_log)
}
```

## Tracing

### Running a package without genthat

```{r load run package parallel log}
run_package_log <- read_parallel_logs("run-package") %>%
  mutate(
    decorator=str_replace(command, ".* --config ([^ ]+) .*", "\\1")
  )
```

We have the run with two decorators, just to measure the overhead of the system.
The `none` decorator entirely skips using R site file so genthat is not touched.
There will still be a bit of an overhead, but similar should be expected when 
using `tools::testInstalledPackages`.

```{r}
prod_run_package_log <- run_package_log %>% filter(decorator=="none")
```

```{r fig.height=15}
prod_run_package_log %>%
  ggplot(aes(
    x=factor(package, levels=package[order(duration)]), 
    y=duration, 
    label=format_difftime(duration))
  ) +
  geom_col() +
  coord_flip() +
  scale_y_time() +
  geom_text(hjust=-.1, size=2) +
  labs(
    title="Package running time [decorator=none, tracer=NA]",
    subtitle="Running examples, tests, vignettes",
    x="Package",
    y="Time [hh:mm:ss]"
  )
```

### Running a package with genthat

```{r load trace parallel log}
trace_log <- read_parallel_logs("trace") %>%
  mutate(
    config=str_replace(command, ".* --config ([^ ]+) .*", "\\1"),
    decorator=str_replace(config, "(.*)--(.*)", "\\1"),
    tracer=str_replace(config, "(.*)--(.*)", "\\2")
  ) %>%
  select(-config)
```

Similarly here, we have multiple decorators and tracers.
For generating tests, we use `onexit` decorator and `set` tracer.
The others are just to find the missed opportunity used for analysis of the efectiveness.

```{r}
prod_trace_log <- trace_log %>% filter(decorator=="onexit", tracer=="set")
```


```{r package tracing time, fig.height=15}
prod_trace_log %>%
  ggplot(aes(
    x=factor(package, levels=package[order(duration)]), 
    y=duration, 
    label=format_difftime(duration))
  ) +
  geom_col() +
  coord_flip() +
  scale_y_time() +
  geom_text(hjust=-.1, size=2) +
  labs(
    title="Package tracing time [decorator=onexit, tracer=set]",
    subtitle="Running examples, tests, vignettes",
    x="Package",
    y="Time [hh:mm:ss]"
  )
```

```{r trace size, fig.height=10}
trace_size <- function(path) {
  rdss <- list.files(
    path=file.path(path, "trace", "output", "onexit--set", "all"), 
    pattern="\\.RDS$", 
    full.names=TRUE, 
    recursive=FALSE
  )
  
  sum(file.size(rdss))
}

traces_size <- result %>% mutate(size=sapply(path, trace_size))

traces_size %>%
  ggplot(
    aes(
      x=factor(package, levels=package[order(size)]), 
      y=size, 
      label=format_size(size)
    )
  ) +
  geom_col() +
  coord_flip() +
  geom_text(hjust=-.1, size=2) +
  # TODO: scale transfioramtion to show units
  labs(
    title="Tracing size [decorator=onexit, tracer=set]",
    subtitle="Running examples, tests, vignettes",
    x="Package",
    y="Size [bytes]"
  )
```

```{r fig.height=15}
prod_trace_log %>% 
  select(package, duration) %>%
  left_join(select(prod_run_package_log, package, duration), by="package") %>%
  mutate(diff=as.integer(duration.x)/as.integer(duration.y)) %>%
  ggplot(aes(x=factor(package, levels=package[order(diff)]), y=diff, label=sprintf("%.2fx", diff))) +
  geom_col() +
  geom_text(hjust=-.1, size=2) +
  coord_flip() +
  labs(
    title="Tracing vs Running",
    subtitle="How much is tracing slower",
    x="Package",
    y="Slowdown"
  )
```

```{r fig.height=10}
traces_size %>% 
  left_join(select(prod_trace_log, package, duration)) %>%
  ggplot(aes(x=as.integer(duration), y=size, label=package)) +
  geom_point() +
  geom_text(size=2, hjust=0.2, nudge_x=0.05) +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    title="Duration of tracing vs traces size",
    x="Duration (log)",
    y="Size (log)"
  )
```

### Summary

```{r fig.heigh=10}
prod_trace_log %>% 
  select(package, duration) %>%
  left_join(select(prod_run_package_log, package, duration), by="package") %>%
  transmute(tracing=as.integer(duration.x), running=as.integer(duration.y)) %>%
  gather(key="key", value="value", tracing, running) %>%
  ggplot(aes(x=key, y=value)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(
    title="Summary of Tracing and Running",
    x="Task",
    y="Duration [s] (log)"
  )
```

```{r fig.height=10}
prod_trace_log %>% 
  select(package, duration) %>%
  left_join(select(prod_run_package_log, package, duration), by="package") %>%
  transmute(
    package, 
    tracing=as.integer(duration.x), 
    running=as.integer(duration.y),
    slowdown=tracing/running
  ) %>%
  ggplot(aes(x=running, y=tracing, label=package, color=slowdown)) +
  geom_jitter() +
  geom_text(size=2, hjust=-0.3, color="black") +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_gradient(low="green", high="red") + 
  labs(
    title="Running vs Tracing",
    x="Running time [s] (log)",
    y="Tracing time [s] (log)"
  )
```


## Test generation

```{r load generate parallel log}
generate_log <- read_parallel_logs("generate")
```

```{r test generating time, fig.height=15}
generate_log %>%
  ggplot(aes(
    x=factor(package, levels=package[order(duration)]), 
    y=duration, 
    label=format_difftime(duration))
  ) +
  geom_col() +
  coord_flip() +
  scale_y_time() +
  geom_text(hjust=-.1, size=2) +
  labs(
    title="Test generating time",
    x="Package",
    y="Time [hh:mm:ss]"
  )
```

## Test runnning

```{r load run parallel log}
run_log <- read_parallel_logs("run")
```

```{r test running time, fig.height=15}
run_log %>%
  ggplot(aes(
    x=factor(package, levels=package[order(duration)]), 
    y=duration, 
    label=format_difftime(duration))
  ) +
  geom_col() +
  coord_flip() +
  scale_y_time() +
  geom_text(hjust=-.1, size=2) +
  labs(
    title="Test running time",
    x="Package",
    y="Time [hh:mm:ss]"
  )
```

## Summary

### Genthat tests vs Package running time

```{r fig.height=15}
prod_run_package_log %>% 
  select(package, duration) %>%
  left_join(select(run_log, package, duration), by="package") %>%
  mutate(diff=as.integer(duration.y)/as.integer(duration.x)) %>%
  ggplot(aes(x=factor(package, levels=package[order(diff)]), y=diff, label=sprintf("%.2fx", diff))) +
  geom_col() +
  geom_text(hjust=-.1, size=2) +
  coord_flip() +
  labs(
    title="Genthat tests vs Package running time",
    subtitle="How much are the genthat tests slower",
    x="Package",
    y="Slowdown"
  )
```


# Data

```{r}
read_csv_checked <- function(...) {
  tryCatch(read_csv(...), error=function(e) {
    message(..1, ": error: ", e$message)
  }, warning=function(e) {
    message(..1, ": warning: ", e$message)
  })
}

load_csvs <- function(path, ...) {
  load_file_from_packages(path, function(package, fname) {
    read_csv_checked(fname, ...) %>%
      mutate(package=package) %>%
      select(package, everything())
  })
}
```


## Traces

```{r}
load_traces_stats <- function(config) {
  load_csvs(file.path("trace", "output", config, "all", "genthat-traces.csv"), 
    col_types=cols_only(
      type="c",
      tag="c",
      filename="c",
      n_traces="i",
      n_complete="i",
      n_entry="i",
      n_failures="i",
      status="i",
      running_time="d"
    )
  )
}

sum_traces <- function(traces) {
  traces %>%
    mutate(
      n_traces=ifelse(is.na(n_traces), 0, n_traces), 
      n_complete=ifelse(is.na(n_complete), 0, n_complete), 
      n_entry=ifelse(is.na(n_entry), 0, n_entry), 
      n_failures=ifelse(is.na(n_failures), 0, n_failures)
    ) %>%
    group_by(package) %>%
    summarise(
      n_traces=sum(n_traces),
      n_complete=sum(n_complete),
      n_entry=sum(n_entry)
    )
}

traces <- load_traces_stats("onexit--set")
```

```{r fig.height=10}
n_traces <- sum_traces(traces)

n_traces %>%
  ggplot(aes(x=factor(package, levels=package[order(n_complete)]), y=n_complete, label=n_complete)) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  coord_flip() +
  labs(
    title="Number of recorder traces",
    x="Package",
    y="Number of traces"
  )
```

### Missed traces

```{r load other trace stats}
count_entry_seq_traces <- load_traces_stats("count-entry--sequence")
count_exit_seq_traces <- load_traces_stats("count-exit--sequence")
onexit_seq_traces <- load_traces_stats("onexit--sequence")

n_count_entry_seq_traces <- count_entry_seq_traces %>% sum_traces()
n_count_exit_seq_traces <- count_exit_seq_traces %>% sum_traces()
n_onexit_seq_traces <- onexit_seq_traces %>% sum_traces()
```

```{r missing traces plot, fig.height=10, include=FALSE}
n_missing_traces <-
  inner_join(
    select(n_count_exit_seq_traces, package, n_entry),
    select(n_onexit_seq_traces, package, n_complete),
    by="package"
  ) %>%
  mutate(missing_traces=ifelse(n_complete > 0, n_complete/n_entry, 0)) %>%
  select(package, missing_traces)

n_missing_traces %>%
  mutate(missing_traces=1-missing_traces) %>%
  ggplot(aes(x=factor(package, levels=package[order(missing_traces)]), y=missing_traces, label=sprintf("%.0f %%", missing_traces*100))) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  scale_y_continuous(labels=scales::percent_format()) +
  coord_flip() +
  labs(
    title="Missing traces",
    subtitle="How many traces did we missed? Counted calls that exit normally.",
    x="Package",
    y="Ratio of missing traces"
  )
```

### Missing calls

```{r missing calls plot, fig.height=10}
n_non_return <-
  inner_join(
    select(n_count_entry_seq_traces, package, entry=n_entry),
    select(n_count_exit_seq_traces, package, exit=n_entry),
    by="package"
  ) %>%
  mutate(missing=ifelse(entry > 0, exit/entry, 0)) %>%
  select(package, missing)

n_non_return %>%
  mutate(missing=1-missing) %>%
  ggplot(aes(x=factor(package, levels=package[order(missing)]), y=missing, label=sprintf("%.0f %%", missing*100))) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  scale_y_continuous(labels=scales::percent_format()) +
  coord_flip() +
  labs(
    title="Missing calls",
    subtitle="How many calls do not exit normally.",
    x="Package",
    y="Ratio of missing calls"
  )
```


## Test Generation

```{r load test generation}
generated_tests <- load_csvs(file.path("generate", "output", "genthat-generate.csv"), col_types=cols_only(
    fun="c",
    test_file="c",
    error="c",
    elapsed="d"
  )
)

# FIXME: just a quick fix
generated_tests <- generated_tests[!duplicated(generated_tests$test_file), ]
```

### Number of tests

```{r number of generated tests, fig.height=10}
n_generated_tests <- 
  generated_tests %>%
  group_by(package) %>%
  summarise(
    generated=sum(!is.na(test_file)),
    failed=sum(is.na(test_file))
  )

n_generated_tests %>%
  ggplot(aes(x=factor(package, levels=package[order(generated)]), y=generated, label=str_c(generated, generated+failed, sep=" / "))) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  coord_flip() +
  labs(
    title="Number of generated tests",
    x="Package",
    y="Number of tests"
  )
```

### Missing tests

```{r fig.height=10}
n_traces %>%
  select(package, traces=n_complete) %>%
  left_join(select(n_generated_tests, package, generated), by="package") %>%
  mutate(diff=traces-generated) %>%
  ggplot(aes(x=factor(package, levels=package[order(diff)]), y=diff, label=diff)) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  coord_flip() +
  labs(
    title="Number of missing tests",
    subtitle="Number of traces with no tests",
    x="Package",
    y="Number of missings tests"
  )

```

### Test size

```{r}
test_sizes <- load_file_from_packages(file.path("generate", "output"), function(package, fname) {
  files <- list.files(fname, pattern="test-.*\\.R$", full.names=TRUE, recursive=TRUE)
  data_frame(file=files, size=file.size(files))
})

test_sizes %>%
  ggplot(aes(size)) +
  geom_histogram(bins=30) +
  scale_x_log10(labels=function(x) {
    if (length(x) == 0) return(character())
    sapply(x, format_size, USE.NAMES=FALSE)
  }) +
  labs(
    title="Distribution of test size",
    x="Size (log)"
  )
```


## Test runs

### Number of tests run

```{r loading run results}
run_tests <- load_csvs(file.path("run", "output", "genthat-run-tests.csv"), col_types=cols_only(
    file="c",
    test="c",
    nb="i",
    failed="i",
    skipped="l",
    error="l",
    warning="i",
    real="d"
  )
)
```

```{r}
run_tests %>% filter(nb > 1) %>% DT::datatable()
```

```{r}
prod_run_tests <-
  run_tests %>%
  filter(is.na(nb) | nb <= 1) %>%
  transmute(
    package,
    fun=test,
    failed=ifelse(is.na(failed), FALSE, failed == 1),
    skipped=ifelse(is.na(skipped), FALSE, skipped),
    error=ifelse(is.na(error), FALSE, error),
    exception=ifelse(is.na(nb), TRUE, FALSE),
    passed=(failed + skipped + error + exception == 0),
    duration=ifelse(is.na(real), 0, real),
    file
  )

# TODO: look at failed tests in exception field
```

The difference is: `r nrow(run_tests) - nrow(prod_run_tests)`

### Problems
```{r}
prod_run_tests %>% rowwise() %>% mutate(x=sum(passed, failed, skipped, error, exception)) %>% filter(x>1)
```


```{r fig.height=10}
n_run_tests <-
  prod_run_tests %>%
  group_by(package) %>%
  summarise(
    count=n(),
    passed=sum(passed),
    failed=sum(failed),
    skipped=sum(skipped),
    error=sum(error),
    exception=sum(exception)
  )

n_run_tests %>%
  gather(key="key", value="value", passed, failed, skipped, error, exception) %>%
  mutate(value=ifelse(is.na(value), 0, value)) %>%
  ggplot(aes(x=package, y=value, fill=key)) +
  geom_col() +
  scale_fill_manual(values=c("error"="orange", "skipped"="gray", "exception"="black", "failed"="red", "passed"="green")) +
  coord_flip()
```

```{r}
n_run_tests %>%
  gather(key="key", value="value", passed, failed, skipped, error, exception, count) %>%
  mutate(value=ifelse(is.na(value), 0, value)) %>%
  ggplot(aes(x=key, y=value)) +
  geom_col() +
  labs(
    title="Summary of running generated tests",
    x="Result",
    y="Number of tests"
  )
```


```{r fig.height=10}
n_generated_tests %>%
  left_join(select(n_run_tests, package, passed), by="package") %>%
  mutate(diff=passed/generated, diff=ifelse(is.na(diff), 0, diff)) %>%
  ggplot(aes(
    x=factor(package, levels=package[rev(order(-diff))]), 
    y=diff, 
    label=str_c(ifelse(is.na(passed), "0", passed), ifelse(is.na(generated), "0", generated), sep=" / "))
  ) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  scale_y_continuous(labels=scales::percent) +
  coord_flip() +
  labs(
    title="Test running success",
    x="package",
    y="Number of tests passed / Number of tests generated"
  )
```

## Summary

```{r success rate}
success_rate <- select(n_traces, package, n_complete) %>%
  left_join(select(n_generated_tests, package, generated), by="package") %>%
  left_join(select(n_run_tests, package, passed), by="package") %>%
  mutate(
    generated=ifelse(is.na(generated), 0, generated),
    passed=ifelse(is.na(passed), 0, passed)
  ) %>%
  mutate(
    generated_traced=ifelse(n_complete > 0, generated/n_complete, 0),
    passed_generated=ifelse(generated > 0, passed/generated, 0),
    passed_traced=ifelse(n_complete > 0, passed/n_complete, 0)
  )
```

```{r success rate overview}
success_rate %>%
  gather(key="key", value="value", generated_traced, passed_generated, passed_traced) %>%
  ggplot(aes(x=key, y=value)) +
  geom_boxplot() +
  scale_y_continuous(labels=scales::percent_format()) +
  labs(
    title="Overall success rate",
    subtitle="How many calls we reproduce?",
    x="Metric",
    y="Success rate"
  )
```

```{r success rate per package, fig.height=10}
success_rate %>%
  gather(key="key", value="value", generated_traced, passed_generated, passed_traced) %>%
  ggplot(aes(x=factor(package, levels=success_rate$package[order(success_rate$passed_traced)]), y=value, label=sprintf("%.0f %%", value*100))) +
  geom_col() +
  geom_text(hjust=-.2, size=2) + 
  scale_y_continuous(labels=scales::percent_format()) +
  coord_flip() +
  facet_grid(. ~ key) +
  labs(
    title="Success rate per package",
    subtitle="How many calls we reproduce?",
    x="Package",
    y="Success rate"
  )
```




