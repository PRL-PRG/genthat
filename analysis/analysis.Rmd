---
title: "R Notebook"
output:
  html_document:
    df_print: paged
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)

library(tidyverse)
library(pbapply)
library(ggplot2)
library(janitor)
library(stringr)
library(anytime)

# this is where the result of the parallel is stored
RUN_DIR=file.path("..", "runs/packages")

package_stat <- function(path) {
  data.frame(
    on.exit_set=file.exists(file.path(path, "trace-on.exit--set", "output", "all", "genthat-traces.csv")),
    on.exit_seq=file.exists(file.path(path, "trace-on.exit--sequence", "output", "all", "genthat-traces.csv")),
    onexit_set=file.exists(file.path(path, "trace-onexit--set", "output", "all", "genthat-traces.csv")),
    onexit_seq=file.exists(file.path(path, "trace-onexit--sequence", "output", "all", "genthat-traces.csv")),
    count_entry_seq=file.exists(file.path(path, "trace-count-entry--sequence", "output", "all", "genthat-traces.csv")),
    count_exit_seq=file.exists(file.path(path, "trace-count-exit--sequence", "output", "all", "genthat-traces.csv")),
    generate=file.exists(file.path(path, "generate", "output", "genthat-generate.csv")),
    run=file.exists(file.path(path, "run", "output", "genthat-run-tests.csv")),
    run_package=file.exists(file.path(path, "run-package", "output", "none", "all", "genthat-traces.csv")),
    coverage=file.exists(file.path(path, "coverage", "output", "all", "covr.RDS"))
  )
}

format_difftime <- function(x, ...) {
  if (is.na(x)) return(NA)

  x <- as.integer(x)
  sprintf(
    "%02d:%02d:%02d", 
    x %% (24*60*60) %/% (60*60),
    x %% (60*60) %/% 60,
    x %% 60 %/% 1
  )
}

format_size <- function(x) {
  if (is.na(x)) return(NA)
  
  units <- c("B", "kB", "MB", "GB", "TB", "PB")
  
  fmt <- function(x, i=1) {
    xx <- x / 1024
    if (abs(xx) > 1 && i < length(units)) {
      fmt(xx, i+1)
    } else {
      sprintf("%.2f %s", x, units[i])
    }
  }
  
  sapply(x, fmt, USE.NAMES=FALSE)
}
```

# Load data

```{r find packages}
all_packages <- 
  data_frame(path=list.dirs(RUN_DIR, recursive=FALSE)) %>%
  filter(!endsWith(path, "/1")) %>%
  mutate(package=basename(path))

all_packages <-
  bind_cols(all_packages, package_stat(all_packages$path))

all_packages_obs <-
  all_packages %>%
  gather(
    key="task", 
    value="success", 
    on.exit_set:coverage
  )

packages <- filter(
  all_packages, 
  on.exit_set==TRUE, 
  on.exit_seq==TRUE, 
  onexit_seq==TRUE, 
  count_entry_seq==TRUE, 
  generate==TRUE, 
  run==TRUE
)

load_file_from_packages <- function(filepath, fun) {
  packages %>%
    transmute(package, fname=file.path(path, filepath)) %>% 
    pmap_dfr(fun)
}
```

## Participating packages

### Run summary

```{r}
all_packages_obs %>%
  filter(success==TRUE) %>%
  count(task) %>%
  DT::datatable()
```

### Details

```{r fig.height=30}
all_packages_obs %>%
  filter(!(task %in% c("onexit_set", "count_exit_seq")), success==FALSE) %>%
  ggplot(aes(
    x=factor(
      task, 
      levels=c(
        "on.exit_set", 
        "on.exit_seq", 
        "onexit_set", 
        "onexit_seq", 
        "count_entry_seq", 
        "count_exit_seq", 
        "generate", 
        "run", 
        "run_package", 
        "coverage"
      )
    ), 
    y=package)
  ) + 
  geom_point() + 
  theme(strip.text.y=element_text(angle = 0)) +
  labs(
    title="Running failures",
    subtitle="Which packages failed which tasks",
    x="Task",
    y="Package"
  )
```

- Failed tracing

```{r}
all_packages %>% 
  filter(on.exit_set==FALSE) %>% 
  select(package) %>%
  DT::datatable()
```

- Failed test generation

```{r}
all_packages %>% 
  filter(on.exit_set==TRUE, generate==FALSE) %>% 
  select(package) %>%
  DT::datatable()
```

- Failed running

```{r}
all_packages %>% 
  filter(on.exit_set==TRUE, generate==TRUE, run==FALSE) %>% 
  select(package) %>%
  DT::datatable()
```

# Results

```{r}
read_csv_checked <- function(...) {
  tryCatch(read_csv(...), error=function(e) {
    message(..1, ": error: ", e$message)
  }, warning=function(e) {
    message(..1, ": warning: ", e$message)
  })
}

load_csvs <- function(path, ...) {
  load_file_from_packages(path, function(package, fname) {
    x <- read_csv_checked(fname, ...)
    x %>%
      mutate(package=package) %>%
      select(package, everything())
  })
}
```

## Traces

TODO: how many package do not have any traces (and why?)

```{r load traces funs}
load_traces_stats <- function(config) {
  load_csvs(file.path(str_c("trace-", config), "output", "all", "genthat-traces.csv"), 
    col_types=cols_only(
      type="c",
      tag="c",
      filename="c",
      n_traces="d",
      n_complete="d",
      n_entry="d",
      n_failures="d",
      status="i",
      running_time="d"
    )
  ) %>% mutate(
    n_traces=ifelse(is.na(n_traces), 0, as.integer(n_traces)), 
    n_complete=ifelse(is.na(n_complete), 0, as.integer(n_complete)), 
    n_entry=ifelse(is.na(n_entry), 0, as.integer(n_entry)), 
    n_failures=ifelse(is.na(n_failures), 0, as.integer(n_failures))
  )
}

sum_traces <- function(traces) {
  traces %>%
    group_by(package) %>%
    summarise(
      n_traces=sum(n_traces),
      n_complete=sum(n_complete),
      n_entry=sum(n_entry)
    )
}
```

```{r load onexit--set traces}
traces <- load_traces_stats("on.exit--set")
```

```{r fig.height=13}
n_traces <- sum_traces(traces)

n_traces %>%
  ggplot(aes(x=factor(package, levels=package[order(n_complete)]), y=n_complete, label=n_complete)) +
  geom_col() +
  geom_text(hjust=-.2, size=2) +
  coord_flip() +
  labs(
    title="Number of recorder traces",
    x="Package",
    y="Number of traces"
  )
```

### Missed traces

```{r load other trace stats}
count_entry_seq_traces <- load_traces_stats("count-entry--sequence")
#count_exit_seq_traces <- load_traces_stats("count-exit--sequence")
onexit_seq_traces <- load_traces_stats("onexit--sequence")
ondotexit_seq_traces <- load_traces_stats("on.exit--sequence")

n_count_entry_seq_traces <- sum_traces(count_entry_seq_traces)
#n_count_exit_seq_traces <- sum_traces(count_exit_seq_traces)
n_onexit_seq_traces <- sum_traces(onexit_seq_traces)
n_ondotexit_seq_traces <- sum_traces(ondotexit_seq_traces)
```

### Missing calls and traces

The following tries to estimate the number of missing calls. A missing call is a call that either did not terminate normally (there was an exception or a long jump) or did exit normally, but there was an exception (or something) that prevented the recorder to store the complete trace.
The former one is referred to as _missed call_ and the latter as _missed trace_.
The way we masure them is by running code with decorators that only records calls entries and exits without looking at any arguments.


```{r missing calls plot, fig.height=13}
missing_calls <-
  inner_join(
    select(count_entry_seq_traces, package, type, tag, n_entry=n_traces),
    select(ondotexit_seq_traces, package, type, tag, n_traces, n_complete),
    by=c("package", "type", "tag")
  ) %>%
  select(package, type, tag, n_entry, n_traces, n_complete)

n_missing_calls <- missing_calls %>%
  group_by(package) %>%
  summarise(
    n_entry=sum(n_entry),
    n_traces=sum(n_traces),
    n_complete=sum(n_complete)
  ) %>%
  mutate(
    calls=ifelse(n_entry > 0, 1-n_traces/n_entry, 0),
    traces=ifelse(n_traces > 0, 1-n_complete/n_traces, 0),
    total=calls+traces
  ) %>%
  select(package, calls, traces, total)

n_missing_calls  %>%
  gather(key="key", value="value", calls, traces) %>%
  filter(value != 0) %>%
  ggplot(
    aes(
      x=factor(package, levels=n_missing_calls$package[order(n_missing_calls$total)]), 
      y=value, 
      fill=key
    )
  ) +
  geom_col(position="dodge") +
  scale_y_continuous(labels=scales::percent_format()) +
  scale_fill_discrete(labels=c("calls"="Missed calls", "traces"="Missed traces")) +
  coord_flip() +
  labs(
    title="Missing calls/traces",
    subtitle="How many calls/traces did we missed?",
    x="Package (for which ration != 0)",
    y="Ratio of missing calls/traces",
    fill="Ratio"
  )
```

The following shows how many calls we miss because there is an exception during the arguments recording.

```{r}
n_missing_calls  %>%
  filter(traces != 0) %>%
  ggplot(
    aes(
      x=factor(package, levels=n_missing_calls$package[order(n_missing_calls$traces)]), 
      y=traces
    )
  ) +
  geom_col() +
  scale_y_continuous(labels=scales::percent_format()) +
  scale_fill_discrete(labels=c("calls"="Missed calls", "traces"="Missed traces")) +
  coord_flip() +
  labs(
    title="Missing traces",
    subtitle="How many traces did we missed?",
    x="Package (for which ration != 0)",
    y="Ratio of missing traces",
    fill="Ratio"
  )
```

## on.exit vs onexit

```{r fig.height=15}
diffs_calls <-
  full_join(
    select(count_entry_seq_traces, package, type, tag, n_entry), 
    select(onexit_seq_traces, package, type, tag, onexit=n_complete),
    by=c("package", "type", "tag")
  ) %>% 
  full_join(
    select(ondotexit_seq_traces, package, type, tag, ondotexit=n_complete),
    by=c("package", "type", "tag")
  ) %>%
  select(package, type, tag, n_entry, onexit, ondotexit)

n_diffs_calls <- diffs_calls %>%
  group_by(package) %>%
  summarise(
    n_entry=sum(n_entry),
    onexit=sum(onexit),
    ondotexit=sum(ondotexit)
  ) %>%
  mutate(
    r1=ifelse(n_entry > 0, 1-onexit/n_entry, 0),
    r2=ifelse(n_entry > 0, 1-ondotexit/n_entry, 0),
    d=ifelse(r1 > 0, r2/r1, 0)
  ) %>%
  select(package, r1, r2, d)

n_diffs_calls %>%
  filter(d != 0) %>%
  ggplot(
    aes(
      x=factor(package, levels=n_diffs_calls$package[order(n_diffs_calls$d)]), 
      y=d
    )
  ) +
  geom_col() +
  scale_y_continuous(labels=scales::percent_format()) +
  coord_flip() +
  labs(
    title="on.exit vs onexit - number of calls on.exit records over onexit",
    subtitle="Which decorator is better?",
    x="Package",
    y="Ratio of captured calls"
  )
```

```{r}
p0 = ggplot(n_diffs_calls, aes(y=d)) + geom_violin(aes(x = "on.exit / onexit"))

# compute lower and upper whiskers
ylim1 = boxplot.stats(n_diffs_calls$d)$stats[c(1, 5)]

# scale y limits based on ylim1
p0 + coord_cartesian(ylim = ylim1*1.05) +   labs(
    title="on.exit vs onexit overview without outliers",
    subtitle="Which decorator is better?",
    y="Ratio of captured calls"
  )
```

## Test Generation

```{r load test generation}
generated_tests <- load_csvs(file.path("generate", "output", "genthat-generate.csv"), col_types=cols_only(
    fun="c",
    test_file="c",
    gen_error="c",
    elapsed="d"
  )
)
```

### Number of tests

```{r number of generated tests, fig.height=13}
n_generated_tests <- 
  generated_tests %>%
  group_by(package) %>%
  summarise(
    generated=sum(!is.na(test_file)),
    failed=sum(is.na(test_file))
  )

n_generated_tests %>%
  left_join(select(n_traces, package, n_complete), by="package") %>%
  mutate(ratio=ifelse(n_complete > 0, 1 - generated / n_complete, 1)) %>%
  filter(ratio != 0) %>%
  ggplot(aes(
    x=factor(package, levels=package[order(ratio)]), 
    y=ratio, 
    label=sprintf("%.2f %%", ratio*100)
  )) +
  geom_col() +
  geom_text(aes(label=sprintf("%d  ", n_complete - generated), y=0), hjust=1, size=2) +
  geom_text(hjust=-.2, size=2) +
  scale_y_continuous(labels=scales::percent_format()) +
  scale_color_identity() +
  coord_flip() +
  labs(
    title="Percentage of missed generated tests",
    subtitle="From how many traces we could not generate tests?",
    x="Package (for which there are missing tests)",
    y="Generated tests [%]"
  )
```

### Test generation problems

The following stats are for all the tests across all the packages.

```{r gen errors}
generated_tests %>%
  mutate(gen_error=ifelse(is.na(gen_error), "No error", gen_error)) %>%
  count(gen_error) %>%
  arrange(desc(n)) %>%
  DT::datatable()
```

```{r}
generated_tests %>%
  mutate(
    gen_error=ifelse(is.na(gen_error), "No error", gen_error),
    gen_error=ifelse(startsWith(gen_error, "Generate error"), "Generate error", gen_error),
    gen_error=ifelse(startsWith(gen_error, "Trace error"), "Trace error", gen_error)
  ) %>%
  count(gen_error) %>%
  arrange(desc(n)) %>%
  DT::datatable()
```

#### Focus on generation errors

```{r}
generated_tests %>% 
  filter(!is.na(gen_error), startsWith(gen_error, "Generate error")) %>%
  count(gen_error, package) %>%
  group_by(package) %>%
  summarise(failed=sum(n), `types of errors`=n()) %>%
  left_join(count(generated_tests, package), by="package") %>%
  mutate(ratio=sprintf("%.0f%%", failed/n*100)) %>%
  arrange(desc(failed/n)) %>%
  DT::datatable()
```

### Test size

```{r load test size}
test_sizes <- load_file_from_packages(file.path("generate", "output"), function(package, fname) {
  files <- list.files(fname, pattern="test-.*\\.R$", full.names=TRUE, recursive=TRUE)
  data_frame(package=package, file=files, size=file.size(files))
})
```

```{r test size, fig.height=13}
test_sizes %>%
  ggplot(aes(x="size", y=size)) +
  geom_violin() +
  scale_y_log10(labels=function(x) {
    if (length(x) == 0) return(character())
    sapply(x, format_size, USE.NAMES=FALSE)
  }) +
  labs(
    title="Distribution of test size",
    x="Size (log)"
  )
```

#### TOP 100

```{r}
test_sizes %>% 
  top_n(100, size) %>% 
  arrange(desc(size)) %>%
  mutate(size=format_size(size)) %>% 
  DT::datatable()
```

## Test runs

```{r loading run results}
run_tests <- load_csvs(file.path("run", "output", "genthat-run-tests.csv"), col_types=cols_only(
    file="c",
    test="c",
    nb="i",
    failed="i",
    error="l",
    warning="i",
    run_error="c",
    elapsed="d"
  )
)
```

### Inconsistent data

There is one expectation per test. Running the code might generate some warnings. 
However, the number of assertions (`nb-waring`) should be 1. 
If it is not, there is a problem.

```{r}
run_tests %>% filter((nb - warning) > 1) %>% count(package) %>% DT::datatable()
```

### Test running problems

```{r run errors}
run_tests %>%
  mutate(run_error=ifelse(is.na(run_error), "No error", run_error)) %>%
  count(run_error) %>%
  arrange(desc(n)) %>%
  DT::datatable()
```

### Test numbers

```{r}
run_tests <-
  run_tests %>%
  filter(is.na(nb) | (nb - warning) <= 1) %>%
  transmute(
    package,
    fun=test,
    failed=ifelse(is.na(failed), FALSE, failed == 1),
    error=ifelse(is.na(error), FALSE, error),
    exception=ifelse(is.na(nb), TRUE, FALSE),
    passed=(failed + error + exception == 0),
    elapsed=ifelse(is.na(elapsed), 0, elapsed),
    file
  )
```

Check inconsitencies

```{r}
run_tests %>% rowwise() %>% mutate(x=sum(passed, failed, error, exception)) %>% filter(x>1)
```

```{r number of tests, fig.height=13}
run_tests %>%
  group_by(package) %>%
  summarise(
    passed=sum(passed)
  ) %>%
  right_join(filter(select(n_generated_tests, package, generated), generated > 0), by="package") %>%
  mutate(ratio=passed / generated) %>%
  ggplot(aes(
    x=factor(package, levels=package[order(ratio)]), 
    y=ratio, 
    label=sprintf("%.2f %%", ratio*100)
  )) +
  geom_col() +
  geom_text(aes(label=sprintf("%d", passed), color=ifelse(passed > 0, "white", "black")), hjust=1.5, size=2) +
  geom_text(hjust=-.2, size=2) +
  scale_y_continuous(labels=scales::percent_format()) +
  scale_color_identity() +
  coord_flip() +
  labs(
    title="Percentage of successfuly ran tests",
    subtitle="How many of the generated tests can we run?",
    x="Package",
    y="[%]"
  )
```

#### Errors

```{r}

```


```{r run tests results, fig.height=13}
n_run_tests <- 
  run_tests %>%
  group_by(package) %>%
  summarise(
    n=n(),
    passed=sum(passed),
    failed=sum(failed),
    error=sum(error),
    exception=sum(exception)
  )

n_run_tests %>%
  mutate(
    passed=ifelse(n > 0, passed/n, 0),
    failed=ifelse(n > 0, failed/n, 0),
    error=ifelse(n > 0, error/n, 0),
    exception=ifelse(n > 0, exception/n, 0)
  ) %>%
  gather(key="key", value="value", passed, failed, error, exception) %>%
  ggplot(aes(x=package, y=value, fill=key)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values=c("error"="orange", "exception"="black", "failed"="red", "passed"="green")) +
  labs(
    title="Test running results",
    x="Package",
    y="Ratio of different results"
  )
```

## Summary

```{r success rate}
success_rate <- select(n_traces, package, n_complete) %>%
  left_join(select(n_generated_tests, package, generated), by="package") %>%
  left_join(select(n_run_tests, package, passed), by="package") %>%
  mutate(
    generated=ifelse(is.na(generated), 0, generated),
    passed=ifelse(is.na(passed), 0, passed)
  ) %>%
  mutate(
    generated_traced=ifelse(n_complete > 0, generated/n_complete, 0),
    passed_generated=ifelse(generated > 0, passed/generated, 0),
    passed_traced=ifelse(n_complete > 0, passed/n_complete, 0)
  )
```

```{r success rate overview}
success_rate %>%
  gather(key="key", value="value", generated_traced, passed_generated, passed_traced) %>%
  ggplot(aes(x=key, y=value)) +
  geom_boxplot() +
  scale_y_continuous(labels=scales::percent_format()) +
  labs(
    title="Overall success rate",
    subtitle="How many calls we reproduce?",
    x="Metric",
    y="Success rate"
  )
```

#### Success rate in numbers

```{r}
stats <- fBasics::basicStats(success_rate %>% select(generated_traced, passed_generated, passed_traced)) %>% as_data_frame()

bind_cols(data_frame(stats=rownames(stats)), stats)
```

```{r success rate per package, fig.height=13}
success_rate %>%
  gather(key="key", value="value", generated_traced, passed_generated, passed_traced) %>%
  ggplot(aes(x=factor(package, levels=success_rate$package[order(success_rate$passed_traced)]), y=value, label=sprintf("%.0f %%", value*100))) +
  geom_col() +
  geom_text(hjust=-.2, size=2) + 
  scale_y_continuous(labels=scales::percent_format()) +
  coord_flip() +
  facet_grid(. ~ key) +
  labs(
    title="Success rate per package",
    subtitle="How many calls we reproduce?",
    x="Package",
    y="Success rate"
  )
```

```{r, fig.height=13}
results <- 
  missing_calls %>% group_by(package) %>% summarise(n_entry=sum(n_entry)) %>%
  left_join(transmute(n_traces, package, traces=n_traces, missing=n_traces-n_complete), by="package") %>%
  left_join(select(n_generated_tests, package, not_generated=failed), by="package") %>%
  left_join(transmute(n_run_tests, package, failed=failed+error+exception, passed=passed), by="package") %>%
  transmute(
    package,
    traces=ifelse(is.na(traces), 0, traces),
    missing=ifelse(is.na(missing), 0, missing),
    not_generated=ifelse(is.na(not_generated), 0, not_generated-missing),
    failed=ifelse(is.na(failed), 0, failed),
    passed=ifelse(is.na(passed), 0, passed)
  )

results %>%
  gather(key="key", value="value", missing, not_generated, failed, passed) %>%
  mutate(value=ifelse(traces > 0, value/traces, 0)) %>%
  ggplot(aes(x=factor(package, levels=results$package[order(results$passed/results$traces)]), y=value, fill=key)) +
  geom_col() +
  coord_flip()
```

# Setup

git commit:

```{sh}
git rev-parse HEAD
```

all packages:

```{r}
all_packages %>% DT::datatable()
```
